name: Bootstrap Azure OIDC (One-Time Setup)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to bootstrap'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  PROJECT_NAME: 'testcontainers'

jobs:
  bootstrap-oidc:
    name: Bootstrap OIDC Resources
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login with Service Principal
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Bootstrap OIDC Resources
        id: bootstrap
        run: |
          set -e
          
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          GITHUB_ORG="${{ github.repository_owner }}"
          GITHUB_REPO="${{ github.event.repository.name }}"
          
          # Get subscription details
          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          TENANT_ID=$(az account show --query tenantId -o tsv)
          
          echo "ðŸš€ Bootstrapping OIDC for:"
          echo "  Organization: $GITHUB_ORG"
          echo "  Repository: $GITHUB_REPO"
          echo "  Environment: $ENVIRONMENT"
          echo "  Subscription: $SUBSCRIPTION_ID"
          echo "  Tenant: $TENANT_ID"
          echo ""
          
          # Application name
          APP_NAME="${PROJECT_NAME}-${ENVIRONMENT}-github-actions"
          
          # Function to create or update federated credential with validation
          create_or_update_federated_credential() {
            local cred_name=$1
            local subject=$2
            local description=$3
            local app_object_id=$4
            
            echo "Validating federated credential: $cred_name"
            
            # First, check if a credential with this SUBJECT already exists (regardless of name)
            # Azure enforces uniqueness on issuer+subject combination
            local existing_creds=$(az ad app federated-credential list \
              --id "$app_object_id" \
              --query "[?subject=='$subject'].name" -o tsv)
            
            if [ -n "$existing_creds" ]; then
              # Credential(s) with this subject exist
              for existing_name in $existing_creds; do
                if [ "$existing_name" = "$cred_name" ]; then
                  # Perfect match - credential is valid
                  echo "âœ“ Credential is valid: $cred_name"
                  return 0
                else
                  # Subject matches but name is different - delete it
                  echo "âš  Found credential with same subject but different name: $existing_name"
                  echo "  Deleting: $existing_name"
                  az ad app federated-credential delete \
                    --id "$app_object_id" \
                    --federated-credential-id "$existing_name" 2>/dev/null || true
                fi
              done
              sleep 2  # Wait for deletions to propagate
            fi
            
            # Check if credential with this NAME exists (but different subject)
            local existing_subject=$(az ad app federated-credential list \
              --id "$app_object_id" \
              --query "[?name=='$cred_name'].subject" -o tsv)
            
            if [ -n "$existing_subject" ] && [ "$existing_subject" != "$subject" ]; then
              echo "âš  Credential name exists but subject mismatch"
              echo "  Expected: $subject"
              echo "  Found:    $existing_subject"
              echo "  Deleting invalid credential: $cred_name"
              
              az ad app federated-credential delete \
                --id "$app_object_id" \
                --federated-credential-id "$cred_name" 2>/dev/null || true
              
              sleep 2  # Wait for deletion to propagate
            fi
            
            # Create credential (either new or replacement)
            echo "Creating federated credential: $cred_name"
            if az ad app federated-credential create \
              --id "$app_object_id" \
              --parameters "{
                \"name\": \"$cred_name\",
                \"issuer\": \"https://token.actions.githubusercontent.com\",
                \"subject\": \"$subject\",
                \"audiences\": [\"api://AzureADTokenExchange\"],
                \"description\": \"$description\"
              }" 2>&1; then
              echo "âœ“ Created credential: $cred_name"
            else
              echo "âš  Creation failed, checking for conflicts..."
              
              # List all credentials with this subject to clean up any stragglers
              local all_with_subject=$(az ad app federated-credential list \
                --id "$app_object_id" \
                --query "[?subject=='$subject'].name" -o tsv)
              
              if [ -n "$all_with_subject" ]; then
                echo "  Found existing credentials with this subject, cleaning up:"
                for name in $all_with_subject; do
                  echo "    Deleting: $name"
                  az ad app federated-credential delete \
                    --id "$app_object_id" \
                    --federated-credential-id "$name" 2>/dev/null || true
                done
                sleep 3
                
                # Retry creation
                echo "  Retrying creation: $cred_name"
                az ad app federated-credential create \
                  --id "$app_object_id" \
                  --parameters "{
                    \"name\": \"$cred_name\",
                    \"issuer\": \"https://token.actions.githubusercontent.com\",
                    \"subject\": \"$subject\",
                    \"audiences\": [\"api://AzureADTokenExchange\"],
                    \"description\": \"$description\"
                  }"
                echo "âœ“ Created credential: $cred_name"
              else
                echo "âœ— Failed to create credential: $cred_name"
                return 1
              fi
            fi
          }
          
          # Function to validate role assignment
          validate_role_assignment() {
            local app_id=$1
            local role=$2
            local subscription_id=$3
            
            local existing_scope=$(az role assignment list \
              --assignee "$app_id" \
              --role "$role" \
              --query "[0].scope" -o tsv)
            
            local expected_scope="/subscriptions/$subscription_id"
            
            if [ "$existing_scope" = "$expected_scope" ]; then
              return 0  # Valid
            else
              return 1  # Invalid or missing
            fi
          }
          
          # Function to clean up invalid role assignments
          cleanup_invalid_roles() {
            local app_id=$1
            local role=$2
            local subscription_id=$3
            
            echo "  Cleaning up invalid role assignments for: $role"
            
            # Get all assignments for this role
            local assignments=$(az role assignment list \
              --assignee "$app_id" \
              --role "$role" \
              --query "[].id" -o tsv)
            
            # Delete assignments not at subscription scope
            for assignment_id in $assignments; do
              if [[ ! "$assignment_id" =~ "/subscriptions/$subscription_id/providers/Microsoft.Authorization" ]]; then
                continue
              fi
              local scope=$(az role assignment list --query "[?id=='$assignment_id'].scope" -o tsv)
              if [ "$scope" != "/subscriptions/$subscription_id" ]; then
                echo "    Removing assignment at incorrect scope: $scope"
                az role assignment delete --ids "$assignment_id" 2>/dev/null || true
              fi
            done
          }
          
          # Function to assign role with validation
          assign_role_with_validation() {
            local app_id=$1
            local role=$2
            local subscription_id=$3
            
            echo "Validating role: $role"
            
            if validate_role_assignment "$app_id" "$role" "$subscription_id"; then
              echo "âœ“ Role is valid: $role"
              return 0
            fi
            
            # Clean up any invalid assignments
            cleanup_invalid_roles "$app_id" "$role" "$subscription_id"
            
            # Create correct role assignment
            echo "Assigning role: $role"
            az role assignment create \
              --assignee "$app_id" \
              --role "$role" \
              --scope "/subscriptions/$subscription_id" \
              2>/dev/null || true
            
            # Wait for propagation
            sleep 5
            
            # Verify assignment
            if validate_role_assignment "$app_id" "$role" "$subscription_id"; then
              echo "âœ“ Assigned role: $role"
            else
              echo "âš  Warning: Role assignment may not have propagated yet: $role"
            fi
          }
          
          # Check if application exists
          echo "Checking if Azure AD Application exists..."
          APP_ID=$(az ad app list --display-name "$APP_NAME" --query "[0].appId" -o tsv)
          
          if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
            echo "Creating Azure AD Application: $APP_NAME"
            APP_ID=$(az ad app create \
              --display-name "$APP_NAME" \
              --query appId -o tsv)
            echo "âœ“ Created application: $APP_ID"
          else
            echo "âœ“ Application already exists: $APP_ID"
          fi
          
          # Get object ID
          APP_OBJECT_ID=$(az ad app show --id "$APP_ID" --query id -o tsv)
          
          # Check if service principal exists
          echo "Checking if Service Principal exists..."
          SP_ID=$(az ad sp list --filter "appId eq '$APP_ID'" --query "[0].id" -o tsv)
          
          if [ -z "$SP_ID" ] || [ "$SP_ID" = "null" ]; then
            echo "Creating Service Principal..."
            SP_ID=$(az ad sp create --id "$APP_ID" --query id -o tsv)
            echo "âœ“ Created service principal: $SP_ID"
            sleep 10  # Wait for SP to propagate
          else
            echo "âœ“ Service Principal already exists: $SP_ID"
          fi
          
          # Create/validate three federated credentials
          echo ""
          echo "Validating federated credentials..."
          
          create_or_update_federated_credential \
            "github-main" \
            "repo:${GITHUB_ORG}/${GITHUB_REPO}:ref:refs/heads/main" \
            "GitHub Actions - Main Branch" \
            "$APP_OBJECT_ID"
          
          create_or_update_federated_credential \
            "github-pr" \
            "repo:${GITHUB_ORG}/${GITHUB_REPO}:pull_request" \
            "GitHub Actions - Pull Requests" \
            "$APP_OBJECT_ID"
          
          create_or_update_federated_credential \
            "github-environment" \
            "repo:${GITHUB_ORG}/${GITHUB_REPO}:environment:${ENVIRONMENT}" \
            "GitHub Actions - Environment: ${ENVIRONMENT}" \
            "$APP_OBJECT_ID"
          
          # Validate and assign roles
          echo ""
          echo "Validating role assignments..."
          
          assign_role_with_validation "$APP_ID" "Contributor" "$SUBSCRIPTION_ID"
          assign_role_with_validation "$APP_ID" "User Access Administrator" "$SUBSCRIPTION_ID"
          
          # Output results
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ“ OIDC Bootstrap Complete!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "GitHub Secrets Configuration:"
          echo ""
          echo "Go to: https://github.com/${GITHUB_ORG}/${GITHUB_REPO}/settings/secrets/actions"
          echo ""
          echo "Add or update these secrets:"
          echo ""
          echo "AZURE_CLIENT_ID:"
          echo "$APP_ID"
          echo ""
          echo "AZURE_TENANT_ID:"
          echo "$TENANT_ID"
          echo ""
          echo "AZURE_SUBSCRIPTION_ID:"
          echo "$SUBSCRIPTION_ID"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Next steps:"
          echo "1. Add the above secrets to GitHub (if not already present)"
          echo "2. Run the 'Deploy Azure Infrastructure (OIDC)' workflow"
          echo "3. Terraform will now authenticate using OIDC"
          echo ""
          
          # Set outputs for potential automation
          echo "client_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "tenant_id=$TENANT_ID" >> $GITHUB_OUTPUT
          echo "subscription_id=$SUBSCRIPTION_ID" >> $GITHUB_OUTPUT

      - name: Display Summary
        run: |
          echo "## âœ“ OIDC Bootstrap Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub Secrets Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add these secrets to your repository:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_CLIENT_ID\`: ${{ steps.bootstrap.outputs.client_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_TENANT_ID\`: ${{ steps.bootstrap.outputs.tenant_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- \`AZURE_SUBSCRIPTION_ID\`: ${{ steps.bootstrap.outputs.subscription_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [Repository Secrets](https://github.com/${{ github.repository }}/settings/secrets/actions)" >> $GITHUB_STEP_SUMMARY
          echo "2. Add the above secrets (copy the IDs exactly, no trailing newlines)" >> $GITHUB_STEP_SUMMARY
          echo "3. Run the **Deploy Azure Infrastructure (OIDC)** workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This bootstrap only needs to run once per environment." >> $GITHUB_STEP_SUMMARY
